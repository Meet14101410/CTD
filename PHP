<?php
// Simulate a database of CTD records
define('CTD_DB_FILE', 'ctd_records.json');

// Function to load CTD records
function loadCTDRecords() {
    if (file_exists(CTD_DB_FILE)) {
        return json_decode(file_get_contents(CTD_DB_FILE), true);
    }
    // Initial dummy data if file doesn't exist
    $initial_data = [
        [
            'id' => 'CTD-001',
            'trialId' => 'TRIAL-001',
            'siteId' => null,
            'documentType' => 'Protocol',
            'tmfZone' => '1. Management',
            'tmfArtifact' => 'Protocol (Main)',
            'title' => 'Phase III Diabetes Study Protocol',
            'version' => '2.0',
            'status' => 'Approved',
            'author' => 'Dr. A. Smith',
            'approvalDate' => '2024-03-10',
            'filePath' => 'protocols/TRIAL-001_Protocol_v2.0.pdf',
            'contentHash' => 'a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2'
        ],
        [
            'id' => 'CTD-002',
            'trialId' => 'TRIAL-001',
            'siteId' => 'SITE-001',
            'documentType' => 'ICF',
            'tmfZone' => '4. IRB/IEC',
            'tmfArtifact' => 'Informed Consent Form - Site',
            'title' => 'Participant ICF for Site 001',
            'version' => '1.1',
            'status' => 'Active',
            'author' => 'Site 001 Coordinator',
            'approvalDate' => '2024-04-05',
            'filePath' => 'icfs/TRIAL-001_SITE-001_ICF_v1.1.pdf',
            'contentHash' => 'f1e2d3c4b5a69876543210fedcba9876543210fedcba9876543210fedcba9876'
        ],
        [
            'id' => 'CTD-003',
            'trialId' => 'TRIAL-002',
            'siteId' => null,
            'documentType' => 'Investigator\'s Brochure',
            'tmfZone' => '3. Regulatory',
            'tmfArtifact' => 'Investigator\'s Brochure',
            'title' => 'IB for Investigational Drug Z',
            'version' => '5.0',
            'status' => 'Approved',
            'author' => 'Sponsor Reg Affairs',
            'approvalDate' => '2023-11-20',
            'filePath' => 'ibs/DrugZ_IB_v5.0.pdf',
            'contentHash' => '1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef'
        ]
    ];
    file_put_contents(CTD_DB_FILE, json_encode($initial_data, JSON_PRETTY_PRINT));
    return $initial_data;
}

$ctdRecords = loadCTDRecords();

// Filter/Search (Conceptual - add actual search logic here)
$filterTrialId = isset($_GET['trialId']) ? htmlspecialchars($_GET['trialId']) : '';
if (!empty($filterTrialId)) {
    $ctdRecords = array_filter($ctdRecords, function($record) use ($filterTrialId) {
        return $record['trialId'] === $filterTrialId;
    });
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Trial Documents Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 20px; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        h2 { text-align: center; color: #0056b3; margin-bottom: 25px; }
        .filter-form { margin-bottom: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px; display: flex; gap: 10px; align-items: center; }
        .filter-form label { font-weight: bold; }
        .filter-form input[type="text"] { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; flex-grow: 1; }
        .filter-form button { background-color: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .ctd-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .ctd-table th, .ctd-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; vertical-align: top; }
        .ctd-table th { background-color: #0056b3; color: white; }
        .ctd-table tr:nth-child(even) { background-color: #f2f2f2; }
        .ctd-table tr:hover { background-color: #e2f0ff; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        .status-Approved { background-color: #28a745; color: white; }
        .status-Active { background-color: #17a2b8; color: white; }
        .status-Draft { background-color: #ffc107; color: #343a40; }
        .status-Submitted { background-color: #6c757d; color: white; }
        .status-Pending { background-color: #fd7e14; color: white; }
        .action-link { color: #007bff; text-decoration: none; }
        .action-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Clinical Trial Documents Dashboard</h2>

        <form class="filter-form" action="" method="get">
            <label for="trialIdFilter">Filter by Trial ID:</label>
            <input type="text" id="trialIdFilter" name="trialId" value="<?php echo $filterTrialId; ?>" placeholder="e.g., TRIAL-001">
            <button type="submit">Apply Filter</button>
            <?php if (!empty($filterTrialId)): ?>
                <button type="button" onclick="window.location.href='ctd_dashboard.php'">Clear Filter</button>
            <?php endif; ?>
        </form>

        <table class="ctd-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Trial ID</th>
                    <th>Site ID</th>
                    <th>Document Type</th>
                    <th>Title</th>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Approval Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php if (empty($ctdRecords)): ?>
                    <tr><td colspan="9" style="text-align: center;">No documents found.</td></tr>
                <?php else: ?>
                    <?php foreach ($ctdRecords as $ctd): ?>
                        <tr>
                            <td><?php echo htmlspecialchars($ctd['id']); ?></td>
                            <td><?php echo htmlspecialchars($ctd['trialId']); ?></td>
                            <td><?php echo htmlspecialchars($ctd['siteId'] ?? 'N/A'); ?></td>
                            <td><?php echo htmlspecialchars($ctd['documentType']); ?></td>
                            <td><?php echo htmlspecialchars($ctd['title']); ?></td>
                            <td><?php echo htmlspecialchars($ctd['version']); ?></td>
                            <td><span class="status-badge status-<?php echo str_replace(' ', '', $ctd['status']); ?>"><?php echo htmlspecialchars($ctd['status']); ?></span></td>
                            <td><?php echo htmlspecialchars($ctd['approvalDate']); ?></td>
                            <td><a href="<?php echo htmlspecialchars($ctd['filePath']); ?>" target="_blank" class="action-link">View</a></td>
                        </tr>
                    <?php endforeach; ?>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</body>
</html>
